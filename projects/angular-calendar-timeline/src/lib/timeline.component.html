<div class='panel-wrapper'>
  <div class='panel-label' [style.height.px]="headerHeight">
    {{ panelLabel}}
  </div>

  <div class='panel'
       mwlResizable
       (resizing)='_handleGroupsPanelResize($event)'
       [resizeSnapGrid]='{right: true}'
       [style.minWidth.px]='groupsPanelWidth'>

    <ng-container *ngFor='let group of items; trackBy: _trackById; let first = first'
                  [ngTemplateOutlet]='groupIterationTemplate'
                  [ngTemplateOutletContext]='{group: group, first: first, depth: 0}'>
    </ng-container>

    <ng-template #groupIterationTemplate let-group='group' let-first='first' let-depth='depth'>
      <div>
        <div [class.first-item]='first'
             [style.height.px]='rowHeight'
             [style.width.px]='groupsPanelWidth'
             [class.can-collapse]='group.items && group.items.length'
             (click)='toggleExpand(group)'
             class='panel-group'>

          <div [style.marginLeft.px]='depth * 15' class='d-flex align-items-center position-relative'>
            <i class='icon-arrow-down'
               [class.collapsed]='!group.expanded'>
            </i>

            <span class='group-name' title="{{group.name}}">{{group.name}}</span>
          </div>
        </div>

        <div *ngIf='group.expanded'>
          <ng-container *ngFor='let innerGroup of (group.items || []); trackBy: _trackById;'
                        [ngTemplateOutletContext]='{group: innerGroup, first: false, depth: depth + 1}'
                        [ngTemplateOutlet]='groupIterationTemplate'
          ></ng-container>
        </div>
      </div>
    </ng-template>
  </div>
</div>

<div class='content-wrapper'>
  <app-timeline-scale-header
    [height]="headerHeight"
    [formatter]="scaleGenerator.formatter"
    [zoom]='zoom'
    [scale]='scale'
    [locale]="locale"
  ></app-timeline-scale-header>

  <div class="column-separators" *ngIf='items && items.length'>
    <div *ngFor='let date of scale?.columns; index as i'
         [style.left.px]='zoom.columnWidth * (i + 1)'
         [style.height]="'calc(100% - ' + headerHeight + 'px)'"
         class='line'>
    </div>
  </div>

  <app-timeline-date-marker [headerHeight]="headerHeight"
                            [leftPosition]='dateMarkerLeftPosition'
                            [customTemplate]="dateMarkerTemplate"
  ></app-timeline-date-marker>

  <div class='timeline-items'>
    <ng-container *ngFor='let group of items; trackBy: _trackById;'>
      <ng-container [ngTemplateOutlet]='itemTemplate'
                    [ngTemplateOutletContext]='{$implicit: group}'
      ></ng-container>

      <ng-container [ngTemplateOutlet]='itemsIterationTemplate'
                    [ngTemplateOutletContext]='{$implicit: group}'
      ></ng-container>
    </ng-container>

    <ng-template #itemTemplate let-item let-first="first" let-last="last">
      <div [class.first-item]='first'
           [class.last-item]='last'
           class='item-row' [style.height.px]='rowHeight'>
        <app-timeline-item class='timeline-item'
                           (cdkDragEnded)='_onItemDropped($event, item)'
                           (dblclick)='itemDblClickHandler(item)'
                           (resizeEnd)='_onItemResizeEnd($event, item)'
                           (resizeStart)='_onItemResizeStart($event)'
                           [cdkDragDisabled]='isItemResizingStarted || !item.canDrag'
                           [enableGhostResize]='true'
                           [item]='item'
                           [style.left.px]='item?.left'
                           [style.width.px]='item?.width'
                           [contentTemplate]='itemContentTemplate'
                           cdkDrag
                           cdkDragBoundary='.item-row'
                           cdkDragLockAxis='x'
                           ghostElementPositioning='absolute'
                           mwlResizable
        ></app-timeline-item>
      </div>
    </ng-template>

    <ng-template #itemsIterationTemplate let-group>
      <ng-container *ngIf='group.expanded'>
        <div *ngFor='let item of (group.items || []); trackBy: _trackById; let first = first; let last = last'>
          <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{
              $implicit: item, first: first, last: last
            }"></ng-container>
        </div>
      </ng-container>

      <ng-container *ngFor='let innerGroup of (group.items || []); trackBy: _trackById;'
                    [ngTemplateOutlet]='itemsIterationTemplate'
                    [ngTemplateOutletContext]='{$implicit: innerGroup}'
      ></ng-container>
    </ng-template>
  </div>
</div>


